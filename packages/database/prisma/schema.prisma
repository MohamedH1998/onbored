generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String              @id
  name               String
  email              String              @unique
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  apiKey             ApiKey[]
  onboardingProgress OnboardingProgress?
  persona            Persona?
  workspaceMember    WorkspaceMember[]
  accounts           Account[]
  sessions           Session[]
  AccountMembership  AccountMembership[]
  invitesCreated     Invite[]

  @@map("user")
}

model Project {
  id              String            @id @default(cuid())
  name            String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  workspaceId     String
  apiKeys         ApiKey[]
  Environment     Environment[]
  FlowInsight     FlowInsight[]
  FlowPathInsight FlowPathInsight[]
  funnels         Funnel[]
  workspace       Workspace         @relation(fields: [workspaceId], references: [id])
  SessionInsight  SessionInsight[]
  SessionReplay   SessionReplay[]
  StepInsight     StepInsight[]
  domain          domain[]
  ProjectAccount  ProjectAccount[]
  activationRules ActivationRule[]

  @@index([workspaceId])
}

model Environment {
  id        String  @id @default(cuid())
  name      String
  slug      String
  projectId String
  apiKeyId  String
  apiKey    ApiKey  @relation(fields: [apiKeyId], references: [id])
  project   Project @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model ApiKey {
  id            String          @id @default(cuid())
  token         String          @unique
  projectId     String
  label         String?
  createdBy     String
  createdAt     DateTime        @default(now())
  expiresAt     DateTime?
  revoked       Boolean         @default(false)
  lastUsedAt    DateTime?
  user          User            @relation(fields: [createdBy], references: [id])
  project       Project         @relation(fields: [projectId], references: [id])
  environment   Environment[]
  sessionReplay SessionReplay[]

  @@index([projectId, revoked])
  @@index([createdBy])
}

model Funnel {
  id               String            @id @default(cuid())
  name             String
  version          String?
  projectId        String
  createdAt        DateTime          @default(now())
  createdById      String
  updatedAt        DateTime          @updatedAt
  status           FunnelStatus      @default(DRAFT)
  slug             String
  insights         FlowInsight[]
  flowPathInsights FlowPathInsight[]
  createdBy        WorkspaceMember   @relation(fields: [createdById], references: [id])
  project          Project           @relation(fields: [projectId], references: [id])
  steps            FunnelStep[]
  stepInsights     StepInsight[]
  activationRules  ActivationRule[]

  @@unique([projectId, name])
  @@unique([projectId, slug])
  @@index([projectId])
}

model FunnelStep {
  id        String   @id @default(cuid())
  funnelId  String
  order     Int
  stepName  String
  metadata  Json?
  createdAt DateTime @default(now())
  key       String
  funnel    Funnel   @relation(fields: [funnelId], references: [id])

  @@unique([funnelId, key])
  @@index([funnelId, order])
}

model StepInsight {
  id               String   @id @default(cuid())
  projectId        String
  stepName         String
  totalViews       Int
  totalSkips       Int
  totalCompletions Int
  dropOffRate      Float
  avgDuration      Float
  timestamp        DateTime @default(now())
  funnelId         String?
  funnel           Funnel?  @relation(fields: [funnelId], references: [id])
  project          Project  @relation(fields: [projectId], references: [id])

  @@index([projectId, stepName])
}

model FlowInsight {
  id                String          @id @default(cuid())
  projectId         String
  totalStarted      Int
  totalCompleted    Int
  avgCompletionTime Float
  completionRate    Float
  trendSummary      String?
  timestamp         DateTime        @default(now())
  funnelId          String
  interval          InsightInterval @default(DAILY)
  intervalEnd       DateTime
  intervalStart     DateTime
  funnel            Funnel          @relation(fields: [funnelId], references: [id])
  project           Project         @relation(fields: [projectId], references: [id])

  @@unique([funnelId, interval, intervalStart])
  @@index([funnelId])
}

model FlowPathInsight {
  id             String   @id @default(cuid())
  projectId      String
  path           String[]
  userCount      Int
  completionRate Float
  avgTime        Float
  updatedAt      DateTime @default(now())
  funnelId       String?
  funnel         Funnel?  @relation(fields: [funnelId], references: [id])
  project        Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model OnboardingProgress {
  id                String    @id @default(cuid())
  userId            String    @unique
  completed         Boolean   @default(false)
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  lastCompletedStep String
  user              User      @relation(fields: [userId], references: [id])
}

model Persona {
  id     String @id @default(cuid())
  userId String @unique
  role   String
  user   User   @relation(fields: [userId], references: [id])
  goals  Goal[] @relation("PersonaGoals")
}

model Goal {
  id       String    @id @default(cuid())
  label    String    @unique
  personas Persona[] @relation("PersonaGoals")
}

model Workspace {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  createdAt       DateTime          @default(now())
  gradient        String            @default("oceanic")
  isAdminOrg      Boolean           @default(false)
  projects        Project[]
  members         WorkspaceMember[]
  CustomerAccount CustomerAccount[]
}

model CustomerAccount {
  id          String              @id @default(cuid())
  workspaceId String
  accountId   String
  name        String
  slug        String
  plan        String?
  mrr         Float?
  lifecycle   String? // trial, active, churn_risk, churned, etc.
  externalId  String? // CRM/Billing id (Stripe/HubSpot/SFDC)
  domains     String[] // company email/web domains
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  workspace   Workspace           @relation(fields: [workspaceId], references: [id])
  memberships AccountMembership[]
  projects    ProjectAccount[]

  @@unique([workspaceId, accountId])
  @@index([accountId])
}

model AccountMembership {
  id          String          @id @default(cuid())
  accountId   String
  userId      String
  role        AccountUserRole @default(MEMBER) // ADMIN, BILLING_OWNER, etc.
  firstSeenAt DateTime        @default(now())
  lastSeenAt  DateTime        @default(now())
  account     CustomerAccount @relation(fields: [accountId], references: [id])
  user        User            @relation(fields: [userId], references: [id])

  @@unique([accountId, userId])
  @@index([userId])
}

model ProjectAccount {
  id        String          @id @default(cuid())
  projectId String
  accountId String
  // Optional per-project traits (plan overrides, seats, env)
  traits    Json?
  project   Project         @relation(fields: [projectId], references: [id])
  account   CustomerAccount @relation(fields: [accountId], references: [id])

  @@unique([projectId, accountId])
  @@index([projectId])
  @@index([accountId])
}

enum AccountUserRole {
  OWNER
  ADMIN
  MEMBER
  BILLING_OWNER
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  funnels     Funnel[]
  user        User          @relation(fields: [userId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model SessionReplay {
  id                String   @id @default(cuid())
  projectId         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  s3Key             String?
  eventCount        Int
  hasFunnelActivity Boolean  @default(false)
  processed         Boolean  @default(false)
  onboredSessionId  String
  apiKeyId          String?
  apiKey            ApiKey?  @relation(fields: [apiKeyId], references: [id])
  project           Project  @relation(fields: [projectId], references: [id])

  @@index([projectId, onboredSessionId])
}

model SessionInsight {
  id                       String      @id @default(cuid())
  sessionId                String
  projectId                String
  description              String
  timestamp                DateTime
  metadata                 Json?
  createdAt                DateTime    @default(now())
  insightType              InsightType
  flowId                   String?
  actionableRecommendation String?
  confidence               Float       @default(0.8)
  funnelStep               String?
  severity                 String?
  signals                  String[]
  userBehaviorSummary      String?
  project                  Project     @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([sessionId])
  @@index([flowId])
  @@index([funnelStep])
  @@index([severity])
}

model domain {
  id        String   @id
  url       String
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime
  Project   Project  @relation(fields: [projectId], references: [id])

  @@unique([projectId, url])
  @@index([projectId])
}

model ActivationRule {
  id          String   @id @default(cuid())
  funnelId    String?
  funnel      Funnel?  @relation(fields: [funnelId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stepName    String?
  eventName   String?
  userProfile String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([funnelId])
  @@index([projectId])
  @@index([userProfile])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum FunnelStatus {
  DRAFT
  PUBLISHED
}

enum InsightInterval {
  DAILY
  WEEKLY
  MONTHLY
}

enum InsightType {
  RAGE_CLICKS
  DEAD_CLICKS
  ERROR_CLICKS
  REPEATED_CLICKS
  MISCLICK
  LONG_IDLE
  FAST_EXIT
  HESITATION
  HIGH_TIME_ON_STEP
  LOW_TIME_ON_STEP
  FORM_ABANDON
  FORM_INPUT_RETRY
  STEP_SKIPPED
  FLOW_INCOMPLETE
  BACKTRACK
  LOOPING
  MULTITAB_BEHAVIOR
  U_TURN
  JS_ERROR
  NETWORK_FAILURE
  SLOW_PAGE_LOAD
  RESOURCE_FAIL
  ELEMENT_HIDDEN
  BUTTON_DISABLED
  CTA_NOT_FOUND
  MODAL_BLOCKED
  BELOW_FOLD_CTA
  COMPLETION
  KEY_ACTION_SUCCESS
  CONTEXTUAL_SUCCESS
  COPY_PASTE
  TEXT_SELECTION
  ZOOM
  CONSOLE_OPENED
  RAPID_NAVIGATION
  HIGH_SCROLL
  LOW_SCROLL
  SCROLL_JANK
  FUNNEL_BOUNCE
  FUNNEL_COMPLETION
  FUNNEL_LOOP
  INTENT_MISMATCH
  STRUGGLE_INFERRED
  DESIGN_CONFUSION
  UNEXPECTED_PATH
  OTHER
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model Invite {
  id          String       @id @default(cuid())
  email       String       @unique
  status      InviteStatus @default(PENDING)
  createdById String?
  createdBy   User?        @relation(fields: [createdById], references: [id])
  createdAt   DateTime     @default(now())
  usedAt      DateTime?

  @@index([email, status])
}

enum InviteStatus {
  APPROVED
  REVOKED
  PENDING
}
